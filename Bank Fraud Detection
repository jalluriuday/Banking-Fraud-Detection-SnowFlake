1. DATABASE, SCHEMAS, WAREHOUSE


CREATE OR REPLACE DATABASE BANKING_FRAUD_DEMO;
USE DATABASE BANKING_FRAUD_DEMO;

CREATE OR REPLACE SCHEMA RAW;
CREATE OR REPLACE SCHEMA ANALYTICS;
CREATE OR REPLACE SCHEMA ALERTS;

CREATE OR REPLACE WAREHOUSE DEMO_WH
  WAREHOUSE_SIZE = 'XSMALL'
  AUTO_SUSPEND = 60
  AUTO_RESUME = TRUE;

USE WAREHOUSE DEMO_WH;


2. RAW TABLES
  

USE SCHEMA RAW;

CREATE OR REPLACE TABLE CUSTOMERS (
    CUSTOMER_ID     NUMBER        PRIMARY KEY,
    NAME            STRING,
    EMAIL           STRING,
    PHONE           STRING,
    CITY            STRING,
    COUNTRY         STRING
);

CREATE OR REPLACE TABLE ACCOUNTS (
    ACCOUNT_ID      NUMBER        PRIMARY KEY,
    CUSTOMER_ID     NUMBER,
    ACCOUNT_TYPE    STRING,
    BALANCE         NUMBER(18,2),
    CREATED_AT      TIMESTAMP_NTZ
);

CREATE OR REPLACE TABLE TRANSACTIONS_RAW (
    TRANSACTION_ID   NUMBER        PRIMARY KEY,
    ACCOUNT_ID       NUMBER,
    CUSTOMER_ID      NUMBER,
    AMOUNT           NUMBER(18,2),
    TRANSACTION_TIME TIMESTAMP_NTZ,
    LOCATION         STRING,
    CHANNEL          STRING,
    TRANSACTION_TYPE STRING
);


 3. SAMPLE DATA (FOR DEMO)
  

INSERT INTO CUSTOMERS (CUSTOMER_ID, NAME, EMAIL, PHONE, CITY, COUNTRY) VALUES
(1, 'Alice', 'alice@example.com', '111-111', 'Mumbai',    'India'),
(2, 'Bob',   'bob@example.com',   '222-222', 'Hyderabad', 'India'),
(3, 'Chris', 'chris@example.com', '333-333', 'New York',  'USA');

INSERT INTO ACCOUNTS (ACCOUNT_ID, CUSTOMER_ID, ACCOUNT_TYPE, BALANCE, CREATED_AT) VALUES
(101, 1, 'SAVINGS', 500000, CURRENT_TIMESTAMP - INTERVAL '60' DAY),
(102, 1, 'CURRENT', 200000, CURRENT_TIMESTAMP - INTERVAL '20' DAY),
(201, 2, 'SAVINGS', 100000, CURRENT_TIMESTAMP - INTERVAL '90' DAY),
(301, 3, 'SAVINGS', 750000, CURRENT_TIMESTAMP - INTERVAL '120' DAY);

INSERT INTO TRANSACTIONS_RAW (
    TRANSACTION_ID, ACCOUNT_ID, CUSTOMER_ID, AMOUNT,
    TRANSACTION_TIME, LOCATION, CHANNEL, TRANSACTION_TYPE
) VALUES
-- Normal transactions
(1, 101, 1,   2000,  CURRENT_TIMESTAMP - INTERVAL '10' MINUTE, 'Mumbai',    'MOBILE', 'DEBIT'),
(2, 101, 1,   3000,  CURRENT_TIMESTAMP - INTERVAL '8'  MINUTE, 'Mumbai',    'MOBILE', 'DEBIT'),
(3, 101, 1,   1500,  CURRENT_TIMESTAMP - INTERVAL '6'  MINUTE, 'Mumbai',    'MOBILE', 'DEBIT'),

-- High value transaction
(4, 101, 1, 200000,  CURRENT_TIMESTAMP - INTERVAL '4'  MINUTE, 'Mumbai',    'WEB',    'DEBIT'),

-- Rapid multiple for Bob
(5, 201, 2,  50000,  CURRENT_TIMESTAMP - INTERVAL '3'  MINUTE, 'Hyderabad', 'WEB',    'DEBIT'),
(6, 201, 2,  60000,  CURRENT_TIMESTAMP - INTERVAL '2'  MINUTE, 'Hyderabad', 'WEB',    'DEBIT'),
(7, 201, 2,  70000,  CURRENT_TIMESTAMP - INTERVAL '1'  MINUTE, 'Hyderabad', 'WEB',    'DEBIT'),

-- Location change for Chris
(8, 301, 3,   4000,  CURRENT_TIMESTAMP - INTERVAL '30' MINUTE, 'New York',  'ATM',    'DEBIT'),
(9, 301, 3,   4500,  CURRENT_TIMESTAMP - INTERVAL '2'  MINUTE, 'London',    'ATM',    'DEBIT');



4. ANALYTICS LAYER (CLEAN TABLE)
  

USE SCHEMA ANALYTICS;

CREATE OR REPLACE TABLE TRANSACTIONS_CLEAN AS
SELECT
    t.TRANSACTION_ID,
    t.ACCOUNT_ID,
    t.CUSTOMER_ID,
    t.AMOUNT,
    t.TRANSACTION_TIME,
    t.LOCATION,
    t.CHANNEL,
    t.TRANSACTION_TYPE,
    c.NAME        AS CUSTOMER_NAME,
    c.CITY        AS CUSTOMER_CITY,
    c.COUNTRY     AS CUSTOMER_COUNTRY,
    a.ACCOUNT_TYPE,
    a.BALANCE
FROM BANKING_FRAUD_DEMO.RAW.TRANSACTIONS_RAW t
LEFT JOIN BANKING_FRAUD_DEMO.RAW.CUSTOMERS c
    ON t.CUSTOMER_ID = c.CUSTOMER_ID
LEFT JOIN BANKING_FRAUD_DEMO.RAW.ACCOUNTS a
    ON t.ACCOUNT_ID = a.ACCOUNT_ID;



5. STREAM FOR INCREMENTAL DATA
  

CREATE OR REPLACE STREAM TRANSACTIONS_CLEAN_STREAM
ON TABLE TRANSACTIONS_CLEAN
APPEND_ONLY = TRUE;



6. ALERTS TABLE
  

USE SCHEMA ALERTS;

CREATE OR REPLACE TABLE SUSPICIOUS_ACTIVITY (
    ALERT_ID          NUMBER AUTOINCREMENT,
    TRANSACTION_ID    NUMBER,
    CUSTOMER_ID       NUMBER,
    ACCOUNT_ID        NUMBER,
    AMOUNT            NUMBER(18,2),
    TRANSACTION_TIME  TIMESTAMP_NTZ,
    LOCATION          STRING,
    REASON            STRING,
    CREATED_AT        TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);



7. FRAUD RULES VIEW (ON FULL DATA)
   

USE SCHEMA ANALYTICS;

CREATE OR REPLACE VIEW FRAUD_RULES_VIEW AS
WITH BASE AS (
    SELECT *
    FROM TRANSACTIONS_CLEAN
)

/* RULE 1: HIGH VALUE TRANSACTIONS */
SELECT
    TRANSACTION_ID,
    CUSTOMER_ID,
    ACCOUNT_ID,
    AMOUNT,
    TRANSACTION_TIME,
    LOCATION,
    'HIGH_VALUE_TRANSACTION' AS REASON
FROM BASE
WHERE AMOUNT > 100000

UNION ALL

/* RULE 2: RAPID MULTIPLE TRANSACTIONS IN LAST 5 MINUTES */
SELECT
    b.TRANSACTION_ID,
    b.CUSTOMER_ID,
    b.ACCOUNT_ID,
    b.AMOUNT,
    b.TRANSACTION_TIME,
    b.LOCATION,
    'RAPID_MULTIPLE_TRANSACTIONS' AS REASON
FROM BASE b
JOIN (
    SELECT
        CUSTOMER_ID,
        COUNT(*) AS TXN_COUNT,
        MIN(TRANSACTION_TIME) AS FIRST_TXN,
        MAX(TRANSACTION_TIME) AS LAST_TXN
    FROM BASE
    WHERE TRANSACTION_TIME >= DATEADD(minute, -5, CURRENT_TIMESTAMP())
    GROUP BY CUSTOMER_ID
    HAVING COUNT(*) >= 3
) agg
ON b.CUSTOMER_ID = agg.CUSTOMER_ID
AND b.TRANSACTION_TIME BETWEEN agg.FIRST_TXN AND agg.LAST_TXN

UNION ALL

/* RULE 3: SUDDEN LOCATION CHANGE */
SELECT
    TRANSACTION_ID,
    CUSTOMER_ID,
    ACCOUNT_ID,
    AMOUNT,
    TRANSACTION_TIME,
    LOCATION,
    'SUDDEN_LOCATION_CHANGE' AS REASON
FROM (
    SELECT
        TRANSACTION_ID,
        CUSTOMER_ID,
        ACCOUNT_ID,
        AMOUNT,
        TRANSACTION_TIME,
        LOCATION,
        LAG(LOCATION) OVER (PARTITION BY CUSTOMER_ID ORDER BY TRANSACTION_TIME) AS PREV_LOCATION
    FROM BASE
) t
WHERE PREV_LOCATION IS NOT NULL
  AND PREV_LOCATION <> LOCATION;


   8. FRAUD VIEW ON STREAM (NEW DATA)

USE SCHEMA ALERTS;

CREATE OR REPLACE VIEW FRAUD_ON_STREAM_VIEW AS
WITH STREAM_BASE AS (
    SELECT *
    FROM BANKING_FRAUD_DEMO.ANALYTICS.TRANSACTIONS_CLEAN_STREAM
),
RULES AS (

    /* HIGH VALUE ON STREAM */
    SELECT
        TRANSACTION_ID,
        CUSTOMER_ID,
        ACCOUNT_ID,
        AMOUNT,
        TRANSACTION_TIME,
        LOCATION,
        'HIGH_VALUE_TRANSACTION' AS REASON
    FROM STREAM_BASE
    WHERE AMOUNT > 100000

    UNION ALL

    /* RAPID MULTIPLE ON STREAM (PER BATCH) */
    SELECT
        b.TRANSACTION_ID,
        b.CUSTOMER_ID,
        b.ACCOUNT_ID,
        b.AMOUNT,
        b.TRANSACTION_TIME,
        b.LOCATION,
        'RAPID_MULTIPLE_TRANSACTIONS' AS REASON
    FROM STREAM_BASE b
    JOIN (
        SELECT
            CUSTOMER_ID,
            COUNT(*) AS TXN_COUNT
        FROM STREAM_BASE
        GROUP BY CUSTOMER_ID
        HAVING COUNT(*) >= 3
    ) agg
    ON b.CUSTOMER_ID = agg.CUSTOMER_ID

    UNION ALL

    /* LOCATION CHANGE ON STREAM */
    SELECT
        TRANSACTION_ID,
        CUSTOMER_ID,
        ACCOUNT_ID,
        AMOUNT,
        TRANSACTION_TIME,
        LOCATION,
        'SUDDEN_LOCATION_CHANGE' AS REASON
    FROM (
        SELECT
            TRANSACTION_ID,
            CUSTOMER_ID,
            ACCOUNT_ID,
            AMOUNT,
            TRANSACTION_TIME,
            LOCATION,
            LAG(LOCATION) OVER (PARTITION BY CUSTOMER_ID ORDER BY TRANSACTION_TIME) AS PREV_LOCATION
        FROM STREAM_BASE
    ) t
    WHERE PREV_LOCATION IS NOT NULL
      AND PREV_LOCATION <> LOCATION
)
SELECT * FROM RULES;


9. TASK TO INSERT ALERTS PERIODICALLY
  

CREATE OR REPLACE TASK FRAUD_ALERT_TASK
WAREHOUSE = DEMO_WH
SCHEDULE = 'USING CRON 0 * * * * UTC'  -- runs every hour
AS
INSERT INTO ALERTS.SUSPICIOUS_ACTIVITY (
    TRANSACTION_ID, CUSTOMER_ID, ACCOUNT_ID, AMOUNT,
    TRANSACTION_TIME, LOCATION, REASON
)
SELECT
    TRANSACTION_ID, CUSTOMER_ID, ACCOUNT_ID, AMOUNT,
    TRANSACTION_TIME, LOCATION, REASON
FROM ALERTS.FRAUD_ON_STREAM_VIEW;

ALTER TASK FRAUD_ALERT_TASK RESUME;


10. CHECK RESULTS (MANUAL QUERIES)

-- View cleaned transactions
SELECT * FROM ANALYTICS.TRANSACTIONS_CLEAN;

-- See fraud matches on full data
SELECT * FROM ANALYTICS.FRAUD_RULES_VIEW;

-- See inserted alerts (after task runs or if you manually run INSERT)
SELECT * FROM ALERTS.SUSPICIOUS_ACTIVITY;

